<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crazy Eights</title>
    <style>
        body {
            background-color: #333333;
            font-family: Arial, sans-serif;
            color: white;
            text-align: center;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #gameContainer {
            display: grid;
            grid-template-areas:
                "computer"
                "discard"
                "player"
                "controls"
                "status";
            grid-template-rows: 220px 1fr 220px auto auto;
            width: 600px;
            height: 800px;
            background-color: #222222;
            border: 2px solid #ff9000;
            border-radius: 10px;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }
        #computerHand, #playerHand {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px 10px 10px 10px;
            height: 220px;
            overflow-y: auto;
        }
        .hand-row {
            display: flex;
            justify-content: center;
            height: 100px;
            margin-bottom: 10px;
        }
        .hand-row .card {
            width: 60px;
            height: 90px;
            margin-left: -20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            position: relative;
        }
        .hand-row .card:first-child {
            margin-left: 0;
        }
        .selected {
            outline: 4px solid #ff9000;
            transform: translateY(-15px);
            z-index: 1;
        }
        #discardPile {
            grid-area: discard;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #discardPile .card {
            width: 60px;
            height: 90px;
            margin: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        #controls {
            grid-area: controls;
            display: flex;
            justify-content: space-around;
            padding: 10px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #ff9000;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #e68300;
        }
        #status {
            grid-area: status;
            text-align: center;
            padding: 10px;
            color: white;
        }
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            z-index: 10;
        }
        #welcomeScreen {
            display: flex;
        }
        #winScreen, #loseScreen {
            display: none;
        }
        .overlay button {
            padding: 10px 20px;
            font-size: 16px;
            margin-left: 10px;
            border: none;
            border-radius: 5px;
            background-color: #ff9000;
            color: white;
            cursor: pointer;
        }
        .overlay button:hover {
            background-color: #e68300;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div id="computerHand"></div>
        <div id="discardPile"></div>
        <div id="playerHand"></div>
        <div id="controls">
            <button id="drawCardButton">Draw Card</button>
            <button id="discardButton">Discard Selected Card</button>
            <button id="newGameButton">New Game</button>
        </div>
        <div id="status">Your turn</div>
        <div id="welcomeScreen" class="overlay">Welcome to Crazy Eights! Click to start.</div>
        <div id="winScreen" class="overlay">You win! <button id="playAgainWin">Play Again</button></div>
        <div id="loseScreen" class="overlay">You lose! <button id="playAgainLose">Play Again</button></div>
    </div>

    <script>
        const cardURLs = {
            "2H": "https://raw.githubusercontent.com/Angelyze/Cards/main/24.png",
            "3H": "https://raw.githubusercontent.com/Angelyze/Cards/main/34.png",
            "4H": "https://raw.githubusercontent.com/Angelyze/Cards/main/44.png",
            "5H": "https://raw.githubusercontent.com/Angelyze/Cards/main/54.png",
            "6H": "https://raw.githubusercontent.com/Angelyze/Cards/main/64.png",
            "7H": "https://raw.githubusercontent.com/Angelyze/Cards/main/74.png",
            "8H": "https://raw.githubusercontent.com/Angelyze/Cards/main/84.png",
            "9H": "https://raw.githubusercontent.com/Angelyze/Cards/main/94.png",
            "10H": "https://raw.githubusercontent.com/Angelyze/Cards/main/104.png",
            "JH": "https://raw.githubusercontent.com/Angelyze/Cards/main/J4.png",
            "QH": "https://raw.githubusercontent.com/Angelyze/Cards/main/Q4.png",
            "KH": "https://raw.githubusercontent.com/Angelyze/Cards/main/K4.png",
            "AH": "https://raw.githubusercontent.com/Angelyze/Cards/main/A4.png",
            "2D": "https://raw.githubusercontent.com/Angelyze/Cards/main/23.png",
            "3D": "https://raw.githubusercontent.com/Angelyze/Cards/main/33.png",
            "4D": "https://raw.githubusercontent.com/Angelyze/Cards/main/43.png",
            "5D": "https://raw.githubusercontent.com/Angelyze/Cards/main/53.png",
            "6D": "https://raw.githubusercontent.com/Angelyze/Cards/main/63.png",
            "7D": "https://raw.githubusercontent.com/Angelyze/Cards/main/73.png",
            "8D": "https://raw.githubusercontent.com/Angelyze/Cards/main/83.png",
            "9D": "https://raw.githubusercontent.com/Angelyze/Cards/main/93.png",
            "10D": "https://raw.githubusercontent.com/Angelyze/Cards/main/103.png",
            "JD": "https://raw.githubusercontent.com/Angelyze/Cards/main/J3.png",
            "QD": "https://raw.githubusercontent.com/Angelyze/Cards/main/Q3.png",
            "KD": "https://raw.githubusercontent.com/Angelyze/Cards/main/K3.png",
            "AD": "https://raw.githubusercontent.com/Angelyze/Cards/main/A3.png",
            "2C": "https://raw.githubusercontent.com/Angelyze/Cards/main/22.png",
            "3C": "https://raw.githubusercontent.com/Angelyze/Cards/main/32.png",
            "4C": "https://raw.githubusercontent.com/Angelyze/Cards/main/42.png",
            "5C": "https://raw.githubusercontent.com/Angelyze/Cards/main/52.png",
            "6C": "https://raw.githubusercontent.com/Angelyze/Cards/main/62.png",
            "7C": "https://raw.githubusercontent.com/Angelyze/Cards/main/72.png",
            "8C": "https://raw.githubusercontent.com/Angelyze/Cards/main/82.png",
            "9C": "https://raw.githubusercontent.com/Angelyze/Cards/main/92.png",
            "10C": "https://raw.githubusercontent.com/Angelyze/Cards/main/102.png",
            "JC": "https://raw.githubusercontent.com/Angelyze/Cards/main/J2.png",
            "QC": "https://raw.githubusercontent.com/Angelyze/Cards/main/Q2.png",
            "KC": "https://raw.githubusercontent.com/Angelyze/Cards/main/K2.png",
            "AC": "https://raw.githubusercontent.com/Angelyze/Cards/main/A2.png",
            "2S": "https://raw.githubusercontent.com/Angelyze/Cards/main/21.png",
            "3S": "https://raw.githubusercontent.com/Angelyze/Cards/main/31.png",
            "4S": "https://raw.githubusercontent.com/Angelyze/Cards/main/41.png",
            "5S": "https://raw.githubusercontent.com/Angelyze/Cards/main/51.png",
            "6S": "https://raw.githubusercontent.com/Angelyze/Cards/main/61.png",
            "7S": "https://raw.githubusercontent.com/Angelyze/Cards/main/71.png",
            "8S": "https://raw.githubusercontent.com/Angelyze/Cards/main/81.png",
            "9S": "https://raw.githubusercontent.com/Angelyze/Cards/main/91.png",
            "10S": "https://raw.githubusercontent.com/Angelyze/Cards/main/101.png",
            "JS": "https://raw.githubusercontent.com/Angelyze/Cards/main/J1.png",
            "QS": "https://raw.githubusercontent.com/Angelyze/Cards/main/Q1.png",
            "KS": "https://raw.githubusercontent.com/Angelyze/Cards/main/K1.png",
            "AS": "https://raw.githubusercontent.com/Angelyze/Cards/main/A1.png",
            "back": "https://raw.githubusercontent.com/Angelyze/Cards/main/back.png"
        };

        const rankMap = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
        const suitMap = ['H', 'D', 'C', 'S'];

        let deck = [];
        let playerHand = [];
        let computerHand = [];
        let discardPile = [];
        let currentSuit = '';
        let playerTurn = true;
        let selectedCardIndex = null;

        const computerHandDiv = document.getElementById('computerHand');
        const discardPileDiv = document.getElementById('discardPile');
        const playerHandDiv = document.getElementById('playerHand');
        const statusDiv = document.getElementById('status');
        const drawCardButton = document.getElementById('drawCardButton');
        const discardButton = document.getElementById('discardButton');
        const newGameButton = document.getElementById('newGameButton');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const winScreen = document.getElementById('winScreen');
        const loseScreen = document.getElementById('loseScreen');
        const playAgainWin = document.getElementById('playAgainWin');
        const playAgainLose = document.getElementById('playAgainLose');

        drawCardButton.addEventListener('click', drawCard);
        discardButton.addEventListener('click', discardSelectedCard);
        newGameButton.addEventListener('click', startNewGame);
        welcomeScreen.addEventListener('click', startGame);
        playAgainWin.addEventListener('click', restartGame);
        playAgainLose.addEventListener('click', restartGame);

        /** Waits for a specified time (helper for delays) */
        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /** Creates a new 52-card deck */
        function createDeck() {
            deck = [];
            for (let rank = 0; rank < 13; rank++) {
                for (let suit = 0; suit < 4; suit++) {
                    deck.push({ rank, suit });
                }
            }
        }

        /** Shuffles an array using Fisher-Yates algorithm */
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /** Deals initial cards to player and computer */
        function dealCards() {
            if (deck.length < 11) {
                console.error("Not enough cards in deck to deal!");
                return;
            }
            playerHand = deck.slice(0, 5);
            computerHand = deck.slice(5, 10);
            deck = deck.slice(10);
            discardPile = [deck.pop()];
            currentSuit = discardPile[0].suit;
            if (rankMap[discardPile[0].rank] === '8') {
                currentSuit = suitMap[Math.floor(Math.random() * 4)];
                statusDiv.textContent = `Game started with an 8. Suit is ${currentSuit}.`;
            } else {
                statusDiv.textContent = `Game started. Match ${suitMap[currentSuit]} or ${rankMap[discardPile[0].rank]}.`;
            }
        }

        /** Updates the UI with current hands and discard pile */
        function displayHands() {
            playerHandDiv.innerHTML = '';
            const playerRow1 = document.createElement('div');
            playerRow1.className = 'hand-row';
            const playerRow2 = document.createElement('div');
            playerRow2.className = 'hand-row';
            playerHand.forEach((card, index) => {
                const img = document.createElement('img');
                img.src = cardURLs[`${rankMap[card.rank]}${suitMap[card.suit]}`];
                img.className = 'card';
                if (index === selectedCardIndex) img.classList.add('selected');
                img.addEventListener('click', () => selectCard(index));
                if (index < 5) {
                    playerRow1.appendChild(img);
                } else {
                    playerRow2.appendChild(img);
                }
            });
            playerHandDiv.appendChild(playerRow1);
            playerHandDiv.appendChild(playerRow2);

            computerHandDiv.innerHTML = '';
            const computerRow1 = document.createElement('div');
            computerRow1.className = 'hand-row';
            const computerRow2 = document.createElement('div');
            computerRow2.className = 'hand-row';
            computerHand.forEach((_, index) => {
                const img = document.createElement('img');
                img.src = cardURLs["back"];
                img.className = 'card';
                if (index < 5) {
                    computerRow1.appendChild(img);
                } else {
                    computerRow2.appendChild(img);
                }
            });
            computerHandDiv.appendChild(computerRow1);
            computerHandDiv.appendChild(computerRow2);

            discardPileDiv.innerHTML = '';
            if (discardPile.length > 0) {
                const img = document.createElement('img');
                img.src = cardURLs[`${rankMap[discardPile[discardPile.length - 1].rank]}${suitMap[discardPile[discardPile.length - 1].suit]}`];
                img.className = 'card';
                discardPileDiv.appendChild(img);
            }
        }

        /** Selects a card in the player's hand */
        function selectCard(index) {
            if (!playerTurn) return;
            selectedCardIndex = index;
            displayHands();
        }

        /** Draws cards from the deck until playable or deck is empty */
        async function drawCard() {
            if (!playerTurn) return;
            if (deck.length === 0) {
                statusDiv.textContent = "Deck empty. Computer’s turn.";
                playerTurn = false;
                setTimeout(computerTurn, 1000);
                return;
            }

            let canPlay = false;
            while (deck.length > 0 && !canPlay) {
                const newCard = deck.pop();
                playerHand.push(newCard);
                canPlay = canDiscard(newCard);
                displayHands();
                statusDiv.textContent = canPlay ? "You drew a playable card!" : "You drew a card.";
                if (!canPlay) {
                    await wait(500);
                }
            }
            if (!canPlay) {
                statusDiv.textContent = "No playable cards drawn. Computer’s turn.";
                playerTurn = false;
                setTimeout(computerTurn, 1000);
            }
        }

        /** Discards the player's selected card if valid */
        function discardSelectedCard() {
            if (!playerTurn || selectedCardIndex === null) return;
            const card = playerHand[selectedCardIndex];
            if (canDiscard(card)) {
                discardPile.push(playerHand.splice(selectedCardIndex, 1)[0]);
                if (rankMap[card.rank] === '8') {
                    callSuit();
                } else {
                    currentSuit = card.suit;
                }
                statusDiv.textContent = `You played ${rankMap[card.rank]}${suitMap[card.suit]}. Computer's turn.`;
                selectedCardIndex = null;
                displayHands();
                checkWin();
                if (playerHand.length > 0) {
                    playerTurn = false;
                    setTimeout(computerTurn, 1000);
                }
            } else {
                statusDiv.textContent = "Invalid card! Must match suit, rank, or be an 8.";
            }
        }

        /** Checks if a card can be discarded */
        function canDiscard(card) {
            const topCard = discardPile[discardPile.length - 1];
            console.log("Checking discard:", {
                cardSuit: suitMap[card.suit],
                cardRank: rankMap[card.rank],
                currentSuit: currentSuit ? suitMap[currentSuit] : 'None',
                topCardSuit: suitMap[topCard.suit],
                topCardRank: rankMap[topCard.rank]
            });
            // Allow discarding if:
            // 1. The card is an 8
            // 2. The card matches the current suit (set after an 8 or from the top card)
            // 3. The card matches the rank of the top card
            return rankMap[card.rank] === '8' ||
                   (currentSuit !== undefined && card.suit === currentSuit) ||
                   rankMap[card.rank] === rankMap[topCard.rank];
        }

        /** Assigns a new suit when an Eight is played */
        function callSuit() {
            currentSuit = suitMap[Math.floor(Math.random() * 4)];
            statusDiv.textContent = `You played an 8 and chose ${currentSuit}. Computer's turn.`;
        }

        /** Handles the computer's turn */
        async function computerTurn() {
            if (playerTurn) return;
            statusDiv.textContent = "Computer's turn...";
            let validCards = computerHand.filter(card => canDiscard(card));
            if (validCards.length > 0) {
                const cardToDiscard = validCards[Math.floor(Math.random() * validCards.length)];
                computerHand.splice(computerHand.indexOf(cardToDiscard), 1);
                discardPile.push(cardToDiscard);
                if (rankMap[cardToDiscard.rank] === '8') {
                    currentSuit = suitMap[Math.floor(Math.random() * 4)];
                    statusDiv.textContent = `Computer played an 8 and chose ${currentSuit}. Your turn.`;
                } else {
                    currentSuit = cardToDiscard.suit;
                    statusDiv.textContent = `Computer played ${rankMap[cardToDiscard.rank]}${suitMap[cardToDiscard.suit]}. Your turn.`;
                }
                displayHands();
                checkWin();
                if (computerHand.length > 0) {
                    playerTurn = true;
                }
            } else if (deck.length > 0) {
                let canPlay = false;
                while (deck.length > 0 && !canPlay) {
                    const newCard = deck.pop();
                    computerHand.push(newCard);
                    canPlay = canDiscard(newCard);
                    displayHands();
                    statusDiv.textContent = canPlay ? "Computer drew a playable card!" : "Computer drew a card.";
                    if (!canPlay) {
                        await wait(500);
                    }
                }
                if (!canPlay) {
                    statusDiv.textContent = "Computer couldn’t play. Your turn.";
                    playerTurn = true;
                } else {
                    computerTurn();
                }
            } else {
                statusDiv.textContent = "Computer passes. Your turn.";
                playerTurn = true;
            }
        }

        /** Checks for a win condition */
        function checkWin() {
            if (playerHand.length === 0) {
                winScreen.style.display = 'flex';
                disableButtons();
            } else if (computerHand.length === 0) {
                loseScreen.style.display = 'flex';
                disableButtons();
            }
        }

        /** Disables interaction buttons on game end */
        function disableButtons() {
            drawCardButton.disabled = true;
            discardButton.disabled = true;
        }

        /** Enables interaction buttons at game start */
        function enableButtons() {
            drawCardButton.disabled = false;
            discardButton.disabled = false;
        }

        /** Starts the game after welcome screen */
        function startGame() {
            welcomeScreen.style.display = 'none';
            startNewGame();
        }

        /** Restarts the game after win/lose */
        function restartGame() {
            winScreen.style.display = 'none';
            loseScreen.style.display = 'none';
            startNewGame();
        }

        /** Starts a new game */
        function startNewGame() {
            console.log("Starting new game...");
            createDeck();
            console.log("Deck created:", deck.length, "cards");
            shuffle(deck);
            console.log("Deck shuffled");
            dealCards();
            console.log("Cards dealt. Player hand:", playerHand, "Computer hand:", computerHand, "Discard pile:", discardPile);
            displayHands();
            console.log("Hands displayed");
            statusDiv.textContent = 'Your turn';
            playerTurn = true;
            selectedCardIndex = null;
            enableButtons();
        }
    </script>
</body>
</html>
